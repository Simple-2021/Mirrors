<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <!--suppress HtmlUnknownTarget -->
    <link href="favicon.ico" id="favicon" rel="shortcut icon" type="svg+xml"/>
    <title>Mirrors</title>
    <!-- :root -->
    <style>
        :root {
            --color: #111;
            --background-color: #fff;
            --border-color: #ccc;
            --placeholder-color: #aaa;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color: #eee;
                --background-color: #111;
                --border-color: #aaa;
                --placeholder-color: #ccc;
            }
        }

    </style>
    <!-- :style -->
    <style>
        * {
            margin: 0;
            padding: 0;
            border: none;
            outline: none;
        }

        body {
            width: 100%;
            position: absolute;
            background-color: var(--background-color);
        }

        input::-webkit-input-placeholder {
            color: var(--placeholder-color);
        }

    </style>
    <!-- class:style -->
    <style>
        .center {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

    </style>
    <!-- id:style -->
    <style>
        #Unit {
            position: relative;
            height: 60px;
            color: var(--color);
            border-radius: 2px;
            border: 1px solid var(--border-color);
            background-color: var(--background-color);
        }

    </style>
    <!-- media:style -->
    <style>
        @media screen and (max-width: 1920px) {
            #Unit {
                padding: 0 18px;
                width: 35%;
                min-width: 576px;
            }
        }

        @media screen and (max-width: 1440px) {
            #Unit {
                padding: 0 17px;
                width: 40%;
                min-width: 480px;
            }
        }

        @media screen and (max-width: 960px) {
            #Unit {
                padding: 0 16px;
                width: 50%;
                min-width: 288px;
            }
        }

        @media screen and (max-width: 480px) {
            #Unit {
                padding: 0 15px;
                width: 60%;
                min-width: 240px;
            }
        }

    </style>

</head>
<body class="center">
<form autocomplete="off" id="frame" method="post">
    <!--suppress HtmlFormInputWithoutLabel -->
    <input autofocus="autofocus" class="center" id="Unit" name="mirror" placeholder="Unit" type="text">

</form>
<!--$-->
<script>
    const $ = (any) => {
        switch (any.charAt(0)) {
            case "#":
                return document.getElementById(any.slice(1));
            case ".":
                return document.getElementsByClassName(any.slice(1));
            default:
                return document.getElementsByTagName(any);
        }
    }
    $.select = (callback, isDirectory) => {
        const tag = document.createElement("input");
        tag.formEnctype = "multipart/form-data";
        tag.type = "file";
        if (isDirectory) {
            tag.webkitdirectory = true;
        }
        tag.multiple = true;
        tag.click();
        tag.onchange = () => {
            callback(tag.files);
            tag.remove();
        }
    }
    $.post = (url, data, success, fail) => {
        const xhr = new XMLHttpRequest();
        xhr.open("post", url);
        xhr.send(data);
        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    success(xhr.response);
                } else {
                    fail(xhr.response);
                }
            }
        }
    }
    $.get = (url, success, fail) => {
        const xhr = new XMLHttpRequest();
        xhr.open("get", url);
        xhr.send()
        xhr.onreadystatechange = () => {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    success(xhr.response);
                } else {
                    fail(xhr.response);
                }
            }
        }
    }

</script>
<!--element-->
<script>
    let index, count;

    Object.prototype.placeholder = function () {
        return this.attributes.getNamedItem("placeholder").value;
    }
    String.prototype.firstUpperCase = function () {
        if (this.length > 0) {
            return this[0].toUpperCase() + this.slice(1);
        }
        return "";
    }
    String.prototype.zh_CN = function () {
        let cn = 0, en = 0;
        for (let char of this) {
            char.charCodeAt(0) > 255 ? cn++ : en++;
        }
        return cn >= en;
    }
    String.prototype.appendPunctuation = function () {
        const chars = ",.!?，。？！…";
        let index = -1;
        let text = this;
        for (let char of chars) {
            if (this.slice(-1) !== char) {
                if (index < this.lastIndexOf(char)) {
                    index = this.lastIndexOf(char);
                }
            }
        }
        if (index !== -1) {
            text = this.slice(-1 * this.length + index + 1);
            return this + (text.zh_CN() ? "。" : ".");
        }
        return this;
    }

</script>
<!--method-->
<script>
    const refresh = () => {
        $.get("/api", (e) => {
            const title = "Mirrors".padEnd(8) + e;
            if (title !== document.title) {
                if (index === count || index === (count - 1)) {
                    index = count = e;
                    refreshMirror();
                } else {
                    count = e;
                    document.title = title;
                }
            }
        });
    }
    const refreshMirror = () => {
        $.get("/api/mirror", (e) => {
            const json = JSON.parse(e);
            document.title = "Mirrors".padEnd(8) + json["K"];
            $("#Unit").placeholder = json["V"];
        });
    }
    const uploadMirror = (files) => {
        const form = new FormData();
        for (i of files) {
            form.append("file", i);
        }
        $.post("/api/upload", form, () => {
            alert("upload succeed");
        }, () => {
            alert("upload failed");
        });
    }
    const downloadMirror = () => {
        const tag = document.createElement("a");
        tag.download = "Mirrors.html";
        tag.href = "/api/download";
        tag.click();
        tag.remove();
    }
    const sync = {
        dark: (mediaQueryList) => {
            if (mediaQueryList === true || mediaQueryList.matches) {
                $("#favicon").href = "favicon.ico?dark=true";
            }
        },
        light: (mediaQueryList) => {
            if (mediaQueryList === true || mediaQueryList.matches) {
                $("#favicon").href = "favicon.ico";
            }
        }
    }

</script>
<script>
    refresh();
    window.setInterval(refresh, 106);
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        sync.dark(true);
    } else {
        sync.light(true);
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener("change", sync.dark);
    window.matchMedia('(prefers-color-scheme: light)').addEventListener("change", sync.light);

</script>

<script>
    $("#frame").onsubmit = () => {
        const form = new FormData();
        const data = $("#Unit").value
            .trim()
            .firstUpperCase()
            .appendPunctuation();
        form.append("mirror", data);
        $.post("/", form, () => {
            console.log("succeed");
            location.reload();
        }, () => {
            console.log("failed");
        });
        return false;
    }
    window.onkeydown = (ev) => {
        if (ev.ctrlKey && ev.key === ("o" || "O")) {
            if (confirm("确定要上传文件?")) {
                $.select(uploadMirror);
            }
            return false;
        } else if (ev.ctrlKey && ev.key === ("s" || "S")) {
            if (confirm("Download File?")) {
                downloadMirror();
            }
            return false;
        }
    }
    window.onwheel = function (e) {
        // noinspection JSUnresolvedVariable
        const dy = e.deltaY || e.wheelDeltaY
        if (dy === (100 || -120)) {
            if (index - 1 > -1) {
                index--
                $.get("/api/mirror?index=" + index, (json) => {
                    $("#Unit").placeholder = JSON.parse(json)["V"];
                })
            }
        } else if (dy === (-100 || 120)) {
            if (index + 1 < count) {
                index++
                $.get("/api/mirror?index=" + index, (json) => {
                    $("#Unit").placeholder = JSON.parse(json)["V"];
                })
            }
        }
    }

</script>

</body>

</html>